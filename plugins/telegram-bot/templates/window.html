<div class="telegram-plugin">
    <div class="plugin-header">
        <span class="plugin-icon">ü§ñ</span>
        <h3>Telegram –ë–æ—Ç</h3>
    </div>
    
    <div class="plugin-status" id="tg-status">
        <span class="status-dot" id="tg-status-dot"></span>
        <span id="tg-status-text">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
    </div>
    
    <div class="plugin-form">
        <div class="form-group">
            <label>Bot Token</label>
            <input type="password" id="tg-token" placeholder="123456:ABC-DEF...">
            <small>–ü–æ–ª—É—á–∏ —É <a href="https://t.me/BotFather" target="_blank">@BotFather</a></small>
        </div>
        
        <div class="form-group">
            <label>–†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ User ID</label>
            <input type="text" id="tg-users" placeholder="123456789, 987654321">
            <small>–û—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º –¥–ª—è –≤—Å–µ—Ö</small>
        </div>
        
        <div class="form-group checkbox">
            <label>
                <input type="checkbox" id="tg-autostart">
                –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
            </label>
        </div>

        <div class="form-group checkbox">
            <label>
                <input type="checkbox" id="tg-mirror-web" checked>
                –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –¥–∏–∞–ª–æ–≥ –≤ –≤–µ–±-—á–∞—Ç
            </label>
        </div>

        <div class="form-group checkbox">
            <label>
                <input type="checkbox" id="tg-group-mode">
                –û–±—â–∏–π —Ä–µ–∂–∏–º –¥–ª—è –≥—Ä—É–ø–ø (–æ—Ç–¥–µ–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å)
            </label>
        </div>

        <div class="form-group checkbox">
            <label>
                <input type="checkbox" id="tg-private-mode" checked>
                –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–õ–°)
            </label>
        </div>

        <div class="form-group">
            <label>–†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ Group ID</label>
            <input type="text" id="tg-groups" placeholder="-1001234567890, -1007778889990">
            <small>–û—Ç–≤–µ—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ —ç—Ç–∏—Ö –≥—Ä—É–ø–ø–∞—Ö (–µ—Å–ª–∏ —Ä–µ–∂–∏–º –≥—Ä—É–ø–ø –≤–∫–ª—é—á—ë–Ω)</small>
        </div>
    </div>
    
    <div class="plugin-actions">
        <button class="btn-primary" id="tg-save" onclick="tgSaveSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn-secondary" id="tg-toggle" onclick="tgToggleBot()">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
    </div>
    
    <div class="plugin-actions" style="margin-top: 10px;">
        <button class="btn-secondary" id="tg-refresh" onclick="tgRefreshChats()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —á–∞—Ç—ã</button>
        <button class="btn-secondary" id="tg-check-access" onclick="tgCheckAccess()">üîê –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø</button>
    </div>

    <div class="plugin-chats" id="tg-chats"></div>
    <div class="plugin-info" id="tg-info"></div>
</div>

<style>
.telegram-plugin { padding: 16px; }
.plugin-header { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
.plugin-icon { font-size: 32px; }
.plugin-header h3 { margin: 0; font-size: 18px; }
.plugin-status { display: flex; align-items: center; gap: 8px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 16px; }
.status-dot { width: 10px; height: 10px; border-radius: 50%; background: #9ca3af; }
.status-dot.running { background: #4ade80; animation: pulse 1.5s infinite; }
.status-dot.error { background: #ef4444; }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
.plugin-form { display: flex; flex-direction: column; gap: 14px; margin-bottom: 16px; }
.form-group { display: flex; flex-direction: column; gap: 4px; }
.form-group label { font-size: 13px; color: var(--text-secondary); }
.form-group input[type="text"], .form-group input[type="password"] {
    padding: 10px 12px; background: var(--bg-input); border: 1px solid var(--border-color);
    border-radius: 6px; color: var(--text-primary); font-size: 13px;
}
.form-group small { font-size: 11px; color: var(--text-muted); }
.form-group small a { color: var(--primary); }
.form-group.checkbox label { display: flex; align-items: center; gap: 8px; cursor: pointer; }
.plugin-actions { display: flex; gap: 10px; }
.plugin-actions button { flex: 1; padding: 10px; }
.plugin-chats { margin-top: 14px; display: flex; flex-direction: column; gap: 8px; max-height: 280px; overflow: auto; }
.chat-row { display: flex; gap: 10px; align-items: flex-start; padding: 8px; border: 1px solid var(--border-color); border-radius: 10px; background: rgba(255,255,255,0.02); }
.chat-avatar {
    width: 34px; height: 34px; border-radius: 999px; display: flex; align-items: center; justify-content: center;
    font-size: 13px; font-weight: 700; color: #fff; background: linear-gradient(135deg, #5b8cff, #57c7a9); flex: 0 0 34px;
}
.chat-main { min-width: 0; flex: 1; }
.chat-title { font-size: 13px; color: var(--text-primary); display: flex; align-items: center; justify-content: space-between; gap: 8px; }
.chat-type { font-size: 11px; color: var(--text-muted); }
.chat-last { font-size: 12px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.chat-author { font-weight: 600; color: var(--text-primary); }
.chat-access { font-size: 11px; margin-top: 2px; }
.chat-access.ok { color: #4ade80; }
.chat-access.fail { color: #ef4444; }
.plugin-info { margin-top: 16px; font-size: 12px; color: var(--text-muted); text-align: center; }
</style>

<script>
(function() {
    let running = false;
    let chatAccess = {};
    
    async function tgAction(action, data = {}) {
        try {
            const r = await fetch('/api/plugins/telegram-bot/action', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action, data})
            });
            if (!r.ok) {
                return {error: `HTTP ${r.status}`, status: 'error'};
            }
            return r.json();
        } catch (e) {
            const info = document.getElementById('tg-info');
            if (info) info.textContent = '‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å, –∑–∞–ø—É—â–µ–Ω–∞ –ª–∏ DARIA.';
            return {error: 'network_error', status: 'error'};
        }
    }
    
    function updateStatus() {
        const dot = document.getElementById('tg-status-dot');
        const text = document.getElementById('tg-status-text');
        const btn = document.getElementById('tg-toggle');
        
        if (running) {
            dot.className = 'status-dot running';
            text.textContent = '–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç';
            btn.textContent = '‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
        } else {
            dot.className = 'status-dot';
            text.textContent = '–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
            btn.textContent = '‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å';
        }
    }

    function escapeHtml(text) {
        return String(text || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function parseIds(raw) {
        if (!raw || !raw.trim()) return [];
        return raw
            .split(',')
            .map(v => parseInt(v.trim(), 10))
            .filter(v => !Number.isNaN(v));
    }

    function accessTextFor(chat) {
        const item = chatAccess[String(chat.id)];
        if (!item) return '';
        const ok = !!(item.access && item.access.ok);
        const reason = item.access && item.access.reason ? String(item.access.reason) : (ok ? 'ok' : 'no_access');
        const safeReason = escapeHtml(reason);
        return `<div class="chat-access ${ok ? 'ok' : 'fail'}">${ok ? '‚úÖ –ú–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å' : '‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞'} (${safeReason})</div>`;
    }

    function avatarFor(chat) {
        const title = String(chat.title || '').trim();
        if (title) return escapeHtml(title[0].toUpperCase());
        return chat.type === 'private' ? '–õ–°' : 'GR';
    }

    function renderChats(chats) {
        const root = document.getElementById('tg-chats');
        if (!chats || !chats.length) {
            root.innerHTML = '<div class="plugin-info">–ü–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤. –ù–∞–ø–∏—à–∏—Ç–µ –±–æ—Ç—É –≤ Telegram, —á—Ç–æ–±—ã –æ–Ω–∏ –ø–æ—è–≤–∏–ª–∏—Å—å.</div>';
            return;
        }
        root.innerHTML = chats.map(chat => `
            <div class="chat-row">
                <div class="chat-avatar">${avatarFor(chat)}</div>
                <div class="chat-main">
                    <div class="chat-title">
                        <span>${escapeHtml(chat.title || String(chat.id))}</span>
                        <span class="chat-type">${escapeHtml(chat.type || 'unknown')}</span>
                    </div>
                    <div class="chat-last"><span class="chat-author">${escapeHtml(chat.last_author || '‚Äî')}:</span> ${escapeHtml(chat.last_message || '‚Äî')}</div>
                    ${accessTextFor(chat)}
                </div>
            </div>
        `).join('');
    }
    
    window.tgSaveSettings = async function() {
        const token = document.getElementById('tg-token').value;
        const usersStr = document.getElementById('tg-users').value;
        const groupsStr = document.getElementById('tg-groups').value;
        const autostart = document.getElementById('tg-autostart').checked;
        const mirrorToWeb = document.getElementById('tg-mirror-web').checked;
        const groupMode = document.getElementById('tg-group-mode').checked;
        const privateMode = document.getElementById('tg-private-mode').checked;
        const users = parseIds(usersStr);
        const groups = parseIds(groupsStr);
        
        await tgAction('save_settings', {
            bot_token: token,
            allowed_users: users,
            allowed_groups: groups,
            auto_start: autostart,
            mirror_to_web: mirrorToWeb,
            group_mode: groupMode,
            private_mode: privateMode,
        });
        
        document.getElementById('tg-info').textContent = '‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!';
        setTimeout(() => document.getElementById('tg-info').textContent = '', 3000);
    };
    
    window.tgToggleBot = async function() {
        const action = running ? 'stop_bot' : 'start_bot';
        const result = await tgAction(action);
        if (result.error) return;
        running = result.running;
        updateStatus();
    };

    window.tgRefreshChats = async function() {
        const result = await tgAction('get_chats');
        if (result.error) return;
        renderChats(result.chats || []);
    };

    window.tgCheckAccess = async function() {
        const result = await tgAction('check_access');
        if (result.error) return;
        chatAccess = {};
        (result.checks || []).forEach(item => {
            chatAccess[String(item.id)] = item;
        });
        const chats = await tgAction('get_chats');
        if (chats.error) return;
        renderChats(chats.chats || []);
    };
    
    // Init
    Promise.all([
        tgAction('get_status'),
        fetch('/api/plugins/telegram-bot/window').then(r => r.ok ? r.json() : ({data: {}, error: `HTTP ${r.status}`})).catch(() => ({data: {}, error: 'network_error'}))
    ]).then(([status, wnd]) => {
        if (status.error || wnd.error) {
            const info = document.getElementById('tg-info');
            if (info) info.textContent = '‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É DARIA.';
            return;
        }
        running = status.running;
        updateStatus();

        const data = wnd.data || {};
        document.getElementById('tg-token').placeholder = data.token_configured ? '–¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω (–æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å)' : '123456:ABC-DEF...';
        document.getElementById('tg-users').value = (data.allowed_users || []).join(', ');
        document.getElementById('tg-groups').value = (data.allowed_groups || []).join(', ');
        document.getElementById('tg-mirror-web').checked = data.mirror_to_web !== false;
        document.getElementById('tg-group-mode').checked = !!data.group_mode;
        document.getElementById('tg-private-mode').checked = data.private_mode !== false;
        document.getElementById('tg-autostart').checked = data.auto_start !== false;
        renderChats(data.chats || []);

        if (!status.has_telegram) {
            document.getElementById('tg-info').innerHTML =
                '‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å: <code>pip install python-telegram-bot</code>';
        }
    });
})();
</script>

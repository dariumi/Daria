<div class="server-plugin">
    <div class="server-header">
        <span class="server-icon">üñ•Ô∏è</span>
        <div>
            <h3>Server Mode</h3>
            <span class="server-status" id="server-status">–í—ã–∫–ª—é—á–µ–Ω</span>
        </div>
        <label class="toggle">
            <input type="checkbox" id="server-toggle" onchange="serverToggle(this.checked)">
            <span class="slider"></span>
        </label>
    </div>
    
    <div class="server-info" id="server-info">
        <p>–ú–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ä–µ–∂–∏–º –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –ª—é–¥—è–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å DARIA —Å –ª–∏—á–Ω—ã–º–∏ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏.</p>
    </div>
    
    <div class="server-tabs">
        <button class="tab active" onclick="serverTab('users')">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
        <button class="tab" onclick="serverTab('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        <button class="tab" onclick="serverTab('add')">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    
    <div class="tab-content" id="tab-users">
        <div class="users-list" id="users-list"></div>
    </div>
    
    <div class="tab-content hidden" id="tab-settings">
        <div class="setting-row">
            <label>–û—Ç–∫—Ä—ã—Ç–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</label>
            <input type="checkbox" id="set-registration" checked>
        </div>
        <div class="setting-row">
            <label>–¢—Ä–µ–±–æ–≤–∞—Ç—å –æ–¥–æ–±—Ä–µ–Ω–∏–µ</label>
            <input type="checkbox" id="set-approval">
        </div>
        <div class="setting-row">
            <label>–ú–∞–∫—Å. –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</label>
            <input type="number" id="set-max" value="10" min="1" max="100">
        </div>
        <button class="btn-primary" onclick="serverSaveSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    
    <div class="tab-content hidden" id="tab-add">
        <div class="form-group">
            <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
            <input type="text" id="new-username" placeholder="username">
        </div>
        <div class="form-group">
            <label>–ü–∞—Ä–æ–ª—å</label>
            <input type="password" id="new-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <button class="btn-primary" onclick="serverCreateUser()">‚ûï –°–æ–∑–¥–∞—Ç—å</button>
    </div>
    
    <div class="server-message" id="server-message"></div>
</div>

<style>
.server-plugin { display: flex; flex-direction: column; gap: 16px; }
.server-header { display: flex; align-items: center; gap: 12px; padding: 16px; background: rgba(0,0,0,0.2); border-radius: 10px; }
.server-icon { font-size: 36px; }
.server-header h3 { margin: 0; font-size: 16px; }
.server-status { font-size: 12px; color: var(--text-muted); }
.server-status.active { color: #4ade80; }
.toggle { position: relative; width: 50px; height: 26px; margin-left: auto; }
.toggle input { opacity: 0; width: 0; height: 0; }
.toggle .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #374151; border-radius: 26px; transition: .3s; }
.toggle .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: .3s; }
.toggle input:checked + .slider { background: var(--primary); }
.toggle input:checked + .slider:before { transform: translateX(24px); }
.server-info { font-size: 13px; color: var(--text-secondary); padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; }
.server-tabs { display: flex; gap: 4px; }
.tab { flex: 1; padding: 10px; background: rgba(255,255,255,0.05); border: none; border-radius: 6px; color: var(--text-secondary); cursor: pointer; font-size: 12px; }
.tab.active { background: var(--primary); color: white; }
.tab-content { padding: 12px 0; }
.tab-content.hidden { display: none; }
.users-list { display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto; }
.user-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px; }
.user-item .user-name { flex: 1; font-size: 14px; }
.user-item .user-status { font-size: 11px; color: var(--text-muted); }
.user-item .user-status.pending { color: #fbbf24; }
.user-item button { background: none; border: none; cursor: pointer; font-size: 14px; opacity: 0.6; }
.user-item button:hover { opacity: 1; }
.setting-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
.setting-row label { font-size: 13px; }
.setting-row input[type="number"] { width: 60px; padding: 6px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); text-align: center; }
.form-group { margin-bottom: 12px; }
.form-group label { display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary); }
.form-group input { width: 100%; padding: 10px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); }
.server-message { font-size: 13px; text-align: center; padding: 10px; border-radius: 6px; }
.server-message.success { background: rgba(74, 222, 128, 0.2); color: #4ade80; }
.server-message.error { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
</style>

<script>
(function() {
    let enabled = false;
    
    async function action(act, data = {}) {
        const r = await fetch('/api/plugins/server-mode/action', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({action: act, data})
        });
        return r.json();
    }
    
    function showMessage(msg, type = 'success') {
        const el = document.getElementById('server-message');
        el.textContent = msg;
        el.className = 'server-message ' + type;
        setTimeout(() => { el.textContent = ''; el.className = 'server-message'; }, 3000);
    }
    
    function updateStatus() {
        const status = document.getElementById('server-status');
        status.textContent = enabled ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–í—ã–∫–ª—é—á–µ–Ω';
        status.classList.toggle('active', enabled);
        document.getElementById('server-toggle').checked = enabled;
    }
    
    async function renderUsers() {
        const result = await action('get_users');
        const list = document.getElementById('users-list');
        
        if (!result.users || result.users.length === 0) {
            list.innerHTML = '<p style="text-align:center;color:var(--text-muted)">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>';
            return;
        }
        
        list.innerHTML = result.users.map(u => `
            <div class="user-item">
                <span class="user-name">üë§ ${u.username}</span>
                <span class="user-status ${u.approved ? '' : 'pending'}">${u.approved ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–û–∂–∏–¥–∞–µ—Ç'}</span>
                ${!u.approved ? `<button onclick="serverApprove('${u.username}')">‚úÖ</button>` : ''}
                <button onclick="serverDelete('${u.username}')">üóëÔ∏è</button>
            </div>
        `).join('');
    }
    
    window.serverTab = function(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        event.target.classList.add('active');
        document.getElementById('tab-' + tab).classList.remove('hidden');
    };
    
    window.serverToggle = async function(value) {
        const result = await action('toggle_server', {enabled: value});
        enabled = result.enabled;
        updateStatus();
        showMessage(enabled ? 'Server Mode –≤–∫–ª—é—á—ë–Ω!' : 'Server Mode –≤—ã–∫–ª—é—á—ë–Ω');
    };
    
    window.serverSaveSettings = async function() {
        await action('save_settings', {
            registration_open: document.getElementById('set-registration').checked,
            require_approval: document.getElementById('set-approval').checked,
            max_users: parseInt(document.getElementById('set-max').value) || 10,
        });
        showMessage('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
    };
    
    window.serverCreateUser = async function() {
        const username = document.getElementById('new-username').value.trim();
        const password = document.getElementById('new-password').value;
        
        if (!username || !password) {
            showMessage('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è', 'error');
            return;
        }
        
        const result = await action('create_user', {username, password});
        if (result.error) {
            showMessage(result.error, 'error');
        } else {
            showMessage(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${username} —Å–æ–∑–¥–∞–Ω!`);
            document.getElementById('new-username').value = '';
            document.getElementById('new-password').value = '';
            renderUsers();
        }
    };
    
    window.serverApprove = async function(username) {
        await action('approve_user', {username});
        showMessage(`${username} –æ–¥–æ–±—Ä–µ–Ω!`);
        renderUsers();
    };
    
    window.serverDelete = async function(username) {
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${username}?`)) return;
        await action('delete_user', {username});
        showMessage(`${username} —É–¥–∞–ª—ë–Ω`);
        renderUsers();
    };
    
    // Init
    action('get_users').then(() => {
        renderUsers();
    });
    
    // Get initial state
    fetch('/api/plugins/server-mode/window').then(r => r.json()).then(data => {
        enabled = data.data?.enabled || false;
        updateStatus();
        
        if (data.data?.settings) {
            document.getElementById('set-registration').checked = data.data.settings.registration_open;
            document.getElementById('set-approval').checked = data.data.settings.require_approval;
            document.getElementById('set-max').value = data.data.settings.max_users || 10;
        }
    });
})();
</script>

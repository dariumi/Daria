<div class="training-plugin">
    <div class="training-header">
        <h3>üìö –û–±—É—á–µ–Ω–∏–µ –î–∞—à–∏</h3>
        <span class="training-count" id="total-count">0 –ø—Ä–∏–º–µ—Ä–æ–≤</span>
    </div>
    
    <div class="training-tabs">
        <button class="tab active" onclick="showTab('examples')">–ü—Ä–∏–º–µ—Ä—ã</button>
        <button class="tab" onclick="showTab('style')">–°—Ç–∏–ª—å</button>
        <button class="tab" onclick="showTab('skills')">–ù–∞–≤—ã–∫–∏</button>
        <button class="tab" onclick="showTab('add')">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    
    <div class="tab-content" id="tab-examples">
        <select id="category-filter" onchange="loadExamples()">
            <option value="all">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
        </select>
        <div class="examples-list" id="examples-list"></div>
    </div>
    
    <div class="tab-content hidden" id="tab-style">
        <div class="form-group">
            <label>–ó–∞–º–µ—Ç–∫–∏ –ø–æ —Å—Ç–∏–ª—é –æ–±—â–µ–Ω–∏—è</label>
            <textarea id="style-notes" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ —É–º–µ—Å—Ç–Ω–æ..."></textarea>
        </div>
        <div class="form-group">
            <label>–ò–∑–±–µ–≥–∞—Ç—å —Ñ—Ä–∞–∑—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
            <input type="text" id="avoid-phrases" placeholder="—Ñ—Ä–∞–∑–∞1, —Ñ—Ä–∞–∑–∞2...">
        </div>
        <div class="form-group">
            <label>–ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—Ä–∞–∑—ã</label>
            <input type="text" id="prefer-phrases" placeholder="—Ñ—Ä–∞–∑–∞1, —Ñ—Ä–∞–∑–∞2...">
        </div>
        <button class="btn-primary" onclick="saveStyle()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∏–ª—å</button>
    </div>

    <div class="tab-content hidden" id="tab-skills">
        <div class="form-group">
            <label>–ù–æ–≤—ã–π –Ω–∞–≤—ã–∫</label>
            <input type="text" id="new-skill-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 3D-—Å–∫—É–ª—å–ø—Ç–∏–Ω–≥">
        </div>
        <div class="form-group">
            <label>–û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–≤—ã–∫–∞</label>
            <textarea id="new-skill-description" placeholder="–ß—Ç–æ –∏–º–µ–Ω–Ω–æ —É–º–µ–µ—Ç –î–∞—à–∞ –≤ —ç—Ç–æ–π —Ç–µ–º–µ"></textarea>
        </div>
        <button class="btn-primary" onclick="addSkill()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–∞–≤—ã–∫</button>
        <div class="examples-list" id="skills-list" style="margin-top:12px"></div>
    </div>
    
    <div class="tab-content hidden" id="tab-add">
        <div class="form-group">
            <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <select id="new-category"></select>
        </div>
        <div class="form-group">
            <label>–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
            <input type="text" id="new-input" placeholder="–ß—Ç–æ –ø–∏—à–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å...">
        </div>
        <div class="form-group">
            <label>–ö–∞–∫ –¥–æ–ª–∂–Ω–∞ –æ—Ç–≤–µ—Ç–∏—Ç—å –î–∞—à–∞</label>
            <textarea id="new-output" placeholder="–ò–¥–µ–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –î–∞—à–∏..."></textarea>
        </div>
        <div class="form-group">
            <label>–ö–æ–Ω—Ç–µ–∫—Å—Ç (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
            <input type="text" id="new-context" placeholder="–í—Ä–µ–º—è —Å—É—Ç–æ–∫, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ —Ç.–¥.">
        </div>
        <button class="btn-primary" onclick="addExample()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä</button>
    </div>
    
    <div class="training-footer">
        <button onclick="exportData()">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
        <label class="upload-btn">
            üì• –ò–º–ø–æ—Ä—Ç
            <input type="file" accept=".json" onchange="importData(this.files[0])" hidden>
        </label>
    </div>
</div>

<style>
.training-plugin { display: flex; flex-direction: column; height: 100%; gap: 12px; }
.training-header { display: flex; justify-content: space-between; align-items: center; }
.training-header h3 { margin: 0; font-size: 16px; }
.training-count { font-size: 12px; color: var(--text-muted); background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 10px; }
.training-tabs { display: flex; gap: 4px; }
.tab { flex: 1; padding: 10px; background: rgba(255,255,255,0.05); border: none; border-radius: 6px; color: var(--text-secondary); cursor: pointer; font-size: 13px; }
.tab.active { background: var(--primary); color: white; }
.tab-content { flex: 1; overflow-y: auto; }
.tab-content.hidden { display: none; }
.form-group { margin-bottom: 12px; }
.form-group label { display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary); }
.form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px 12px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 13px; }
.form-group textarea { min-height: 80px; resize: vertical; }
#category-filter { margin-bottom: 12px; }
.examples-list { display: flex; flex-direction: column; gap: 8px; }
.example-item { padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; position: relative; }
.example-item .example-input { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
.example-item .example-output { font-size: 13px; color: var(--primary); }
.example-item .example-delete { position: absolute; top: 8px; right: 8px; background: none; border: none; color: var(--text-muted); cursor: pointer; opacity: 0.5; }
.example-item:hover .example-delete { opacity: 1; }
.training-footer { display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid var(--border-color); }
.training-footer button, .training-footer .upload-btn { padding: 8px 16px; background: rgba(255,255,255,0.1); border: none; border-radius: 6px; color: var(--text-primary); cursor: pointer; font-size: 12px; }
.empty-state { text-align: center; padding: 30px; color: var(--text-muted); }
</style>

<script>
(function() {
    let categories = {};
    let examples = {};
    let style = {};
    let skills = [];
    
    async function action(act, data = {}) {
        const r = await fetch('/api/plugins/training/action', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({action: act, data})
        });
        return r.json();
    }
    
    window.showTab = function(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        event.target.classList.add('active');
        document.getElementById('tab-' + tab).classList.remove('hidden');
    };
    
    async function init() {
        const r = await fetch('/api/plugins/training/window');
        const data = await r.json();
        
        categories = data.data?.categories || {};
        examples = data.data?.examples || {};
        style = data.data?.style || {};
        skills = data.data?.skills || [];
        
        // Fill category selects
        const filter = document.getElementById('category-filter');
        const newCat = document.getElementById('new-category');
        
        Object.entries(categories).forEach(([key, name]) => {
            filter.innerHTML += `<option value="${key}">${name}</option>`;
            newCat.innerHTML += `<option value="${key}">${name}</option>`;
        });
        
        // Fill style
        document.getElementById('style-notes').value = style.notes || '';
        document.getElementById('avoid-phrases').value = (style.avoid_phrases || []).join(', ');
        document.getElementById('prefer-phrases').value = (style.preferred_phrases || []).join(', ');
        
        updateCount();
        loadExamples();
        renderSkills();
    }
    
    function updateCount() {
        const total = Object.values(examples).reduce((sum, arr) => sum + arr.length, 0);
        document.getElementById('total-count').textContent = total + ' –ø—Ä–∏–º–µ—Ä–æ–≤';
    }
    
    window.loadExamples = function() {
        const category = document.getElementById('category-filter').value;
        const list = document.getElementById('examples-list');
        
        let items = [];
        if (category === 'all') {
            Object.entries(examples).forEach(([cat, exs]) => {
                exs.forEach((ex, i) => items.push({...ex, category: cat, index: i}));
            });
        } else {
            (examples[category] || []).forEach((ex, i) => items.push({...ex, category, index: i}));
        }
        
        if (!items.length) {
            list.innerHTML = '<div class="empty-state">–ù–µ—Ç –ø—Ä–∏–º–µ—Ä–æ–≤</div>';
            return;
        }
        
        list.innerHTML = items.map(ex => `
            <div class="example-item">
                <div class="example-input">üë§ ${ex.input}</div>
                <div class="example-output">üå∏ ${ex.output}</div>
                <button class="example-delete" onclick="deleteExample('${ex.category}', ${ex.index})">üóëÔ∏è</button>
            </div>
        `).join('');
    };
    
    window.addExample = async function() {
        const result = await action('add_example', {
            category: document.getElementById('new-category').value,
            input: document.getElementById('new-input').value,
            output: document.getElementById('new-output').value,
            context: document.getElementById('new-context').value,
        });
        
        if (result.error) {
            alert(result.error);
            return;
        }
        
        document.getElementById('new-input').value = '';
        document.getElementById('new-output').value = '';
        document.getElementById('new-context').value = '';
        
        // Reload
        const r = await action('get_examples', {category: 'all'});
        examples = r.examples || {};
        updateCount();
        loadExamples();
        
        alert('–ü—Ä–∏–º–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω! üå∏');
    };
    
    window.deleteExample = async function(category, index) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–º–µ—Ä?')) return;
        await action('delete_example', {category, index});
        
        const r = await action('get_examples', {category: 'all'});
        examples = r.examples || {};
        updateCount();
        loadExamples();
    };
    
    window.saveStyle = async function() {
        const avoid = document.getElementById('avoid-phrases').value.split(',').map(s => s.trim()).filter(s => s);
        const prefer = document.getElementById('prefer-phrases').value.split(',').map(s => s.trim()).filter(s => s);
        
        await action('save_style', {
            notes: document.getElementById('style-notes').value,
            avoid_phrases: avoid,
            preferred_phrases: prefer,
        });
        
        alert('–°—Ç–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω! üíï');
    };

    window.renderSkills = function() {
        const list = document.getElementById('skills-list');
        if (!list) return;
        if (!skills.length) {
            list.innerHTML = '<div class="empty-state">–ù–∞–≤—ã–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
            return;
        }
        list.innerHTML = skills.map((s, i) => `
            <div class="example-item">
                <div class="example-input">üéØ ${s.name}</div>
                <div class="example-output">${s.description}</div>
                <button class="example-delete" onclick="deleteSkill(${i})">üóëÔ∏è</button>
            </div>
        `).join('');
    };

    window.addSkill = async function() {
        const name = document.getElementById('new-skill-name').value.trim();
        const description = document.getElementById('new-skill-description').value.trim();
        const result = await action('add_skill', {name, description});
        if (result.error) {
            alert(result.error);
            return;
        }
        skills.push({name, description});
        document.getElementById('new-skill-name').value = '';
        document.getElementById('new-skill-description').value = '';
        renderSkills();
    };

    window.deleteSkill = async function(index) {
        await action('delete_skill', {index});
        skills = skills.filter((_, i) => i !== index);
        renderSkills();
    };
    
    window.exportData = async function() {
        const result = await action('export');
        const blob = new Blob([JSON.stringify(result.data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'daria-training.json';
        a.click();
    };
    
    window.importData = async function(file) {
        if (!file) return;
        const text = await file.text();
        try {
            const data = JSON.parse(text);
            await action('import', {data});
            
            const r = await action('get_examples', {category: 'all'});
            examples = r.examples || {};
            updateCount();
            loadExamples();
            
            alert('–î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã! üå∏');
        } catch (e) {
            alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + e.message);
        }
    };
    
    init();
})();
</script>

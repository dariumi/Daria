<div class="games-plugin">
    <div class="games-header">
        <h3>üéÆ –ò–≥—Ä–∞–µ–º —Å –î–∞—à–µ–π</h3>
        <div class="games-stats">
            <span>üèÜ <span id="wins">0</span></span>
            <span>üò¢ <span id="losses">0</span></span>
        </div>
    </div>
    
    <div class="games-menu" id="games-menu">
        <button class="game-btn" onclick="startGame('tictactoe')">
            <span>‚≠ï</span>
            <span>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏</span>
        </button>
        <button class="game-btn" onclick="startGame('memory')">
            <span>üÉè</span>
            <span>Memory</span>
        </button>
        <button class="game-btn" onclick="startGame('reaction')">
            <span>‚ö°</span>
            <span>–†–µ–∞–∫—Ü–∏—è</span>
        </button>
        <button class="game-btn" onclick="startGame('snake')">
            <span>üêç</span>
            <span>–ó–º–µ–π–∫–∞</span>
        </button>
    </div>
    
    <div class="game-area hidden" id="game-area">
        <div class="game-back">
            <button onclick="backToMenu()">‚Üê –ù–∞–∑–∞–¥</button>
            <span id="daria-comment">–ò–≥—Ä–∞–µ–º! üå∏</span>
        </div>
        <div id="game-content"></div>
    </div>
</div>

<style>
.games-plugin { display: flex; flex-direction: column; height: 100%; }
.games-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.games-header h3 { margin: 0; font-size: 16px; }
.games-stats { display: flex; gap: 12px; font-size: 14px; }
.games-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.game-btn { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 24px 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); border-radius: 12px; cursor: pointer; transition: all 0.2s; color: var(--text-primary); }
.game-btn:hover { background: rgba(255,255,255,0.1); transform: translateY(-2px); }
.game-btn span:first-child { font-size: 32px; }
.game-btn span:last-child { font-size: 13px; }
.game-area.hidden { display: none; }
.game-back { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
.game-back button { padding: 6px 12px; background: rgba(255,255,255,0.1); border: none; border-radius: 6px; color: var(--text-primary); cursor: pointer; }
#daria-comment { flex: 1; text-align: center; font-size: 13px; color: var(--primary); }

/* Tic Tac Toe */
.ttt-board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; max-width: 240px; margin: 0 auto; }
.ttt-cell { aspect-ratio: 1; background: rgba(255,255,255,0.1); border: 1px solid var(--border-color); border-radius: 8px; font-size: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
.ttt-cell:hover:not(.taken) { background: rgba(255,255,255,0.15); }
.ttt-cell.taken { cursor: default; }
.ttt-cell.x { color: #60a5fa; }
.ttt-cell.o { color: var(--primary); }
.ttt-result { text-align: center; margin-top: 16px; font-size: 16px; }

/* Memory */
.memory-board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; max-width: 280px; margin: 0 auto; }
.memory-card { aspect-ratio: 1; background: var(--primary); border-radius: 8px; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; }
.memory-card.flipped, .memory-card.matched { background: rgba(255,255,255,0.1); }
.memory-card:not(.flipped):not(.matched) span { visibility: hidden; }
.memory-card.matched { opacity: 0.5; cursor: default; }

/* Reaction */
.reaction-area { text-align: center; padding: 40px 20px; }
.reaction-target { width: 120px; height: 120px; border-radius: 50%; margin: 20px auto; display: flex; align-items: center; justify-content: center; font-size: 48px; transition: all 0.2s; }
.reaction-target.waiting { background: rgba(255,255,255,0.1); }
.reaction-target.ready { background: #ef4444; cursor: pointer; animation: pulse 0.5s infinite; }
.reaction-target.clicked { background: #4ade80; }
@keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.05); } }
.reaction-result { font-size: 24px; font-weight: 700; margin: 16px 0; }

/* Snake */
.snake-area { text-align: center; }
.snake-canvas { background: #0a0a0a; border-radius: 8px; display: block; margin: 0 auto; }
.snake-score { margin-top: 12px; font-size: 16px; }
.snake-controls { display: flex; gap: 8px; justify-content: center; margin-top: 12px; }
.snake-controls button { padding: 12px 16px; background: rgba(255,255,255,0.1); border: none; border-radius: 6px; color: var(--text-primary); font-size: 18px; cursor: pointer; }
</style>

<script>
(function() {
    let currentGame = null;
    let gameState = {};
    
    async function action(act, data = {}) {
        const r = await fetch('/api/plugins/games/action', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({action: act, data})
        });
        return r.json();
    }
    
    function setComment(text) {
        document.getElementById('daria-comment').textContent = text;
    }
    
    window.startGame = function(game) {
        currentGame = game;
        document.getElementById('games-menu').classList.add('hidden');
        document.getElementById('game-area').classList.remove('hidden');
        
        const content = document.getElementById('game-content');
        
        if (game === 'tictactoe') initTicTacToe(content);
        else if (game === 'memory') initMemory(content);
        else if (game === 'reaction') initReaction(content);
        else if (game === 'snake') initSnake(content);
    };
    
    window.backToMenu = function() {
        document.getElementById('games-menu').classList.remove('hidden');
        document.getElementById('game-area').classList.add('hidden');
        document.getElementById('game-content').innerHTML = '';
        currentGame = null;
        gameState = {};
        setComment('–ò–≥—Ä–∞–µ–º! üå∏');
    };
    
    // Tic Tac Toe
    function initTicTacToe(container) {
        gameState.board = Array(9).fill('');
        gameState.turn = 'X';
        gameState.over = false;
        
        container.innerHTML = `
            <div class="ttt-board">${Array(9).fill('<div class="ttt-cell" onclick="tttClick(this)"></div>').join('')}</div>
            <div class="ttt-result" id="ttt-result"></div>
        `;
        setComment('–¢–≤–æ–π —Ö–æ–¥! –¢—ã –∏–≥—Ä–∞–µ—à—å –∑–∞ X üéØ');
    }
    
    window.tttClick = async function(cell) {
        if (gameState.over || gameState.turn !== 'X') return;
        const idx = [...cell.parentElement.children].indexOf(cell);
        if (gameState.board[idx]) return;
        
        gameState.board[idx] = 'X';
        cell.textContent = 'X';
        cell.classList.add('taken', 'x');
        
        if (checkTTTWin('X')) {
            endTTT('lose', '–¢—ã –ø–æ–±–µ–¥–∏–ª! üéâ');
            return;
        }
        if (gameState.board.every(c => c)) {
            endTTT('draw', '–ù–∏—á—å—è! ü§ù');
            return;
        }
        
        gameState.turn = 'O';
        setComment('–î—É–º–∞—é... ü§î');
        
        const result = await action('tic_tac_toe_move', {board: gameState.board});
        if (result.move >= 0) {
            setTimeout(() => {
                gameState.board[result.move] = 'O';
                const cells = document.querySelectorAll('.ttt-cell');
                cells[result.move].textContent = 'O';
                cells[result.move].classList.add('taken', 'o');
                
                if (checkTTTWin('O')) {
                    endTTT('win', result.comment || '–Ø –ø–æ–±–µ–¥–∏–ª–∞! üéâ');
                } else {
                    gameState.turn = 'X';
                    setComment(result.comment || '–¢–≤–æ–π —Ö–æ–¥!');
                }
            }, 500);
        }
    };
    
    function checkTTTWin(p) {
        const w = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
        return w.some(l => l.every(i => gameState.board[i] === p));
    }
    
    async function endTTT(result, msg) {
        gameState.over = true;
        document.getElementById('ttt-result').textContent = msg;
        setComment(msg);
        await action('game_result', {result});
        updateStats();
    }
    
    // Memory
    function initMemory(container) {
        const emojis = ['üå∏','üíï','‚≠ê','üéÄ','üåô','üíé','ü¶ã','üå∫'];
        const cards = [...emojis, ...emojis].sort(() => Math.random() - 0.5);
        gameState.cards = cards;
        gameState.flipped = [];
        gameState.matched = 0;
        
        container.innerHTML = `<div class="memory-board">${cards.map((e,i) => 
            `<div class="memory-card" onclick="memoryClick(${i})"><span>${e}</span></div>`
        ).join('')}</div>`;
        setComment('–ù–∞–π–¥–∏ –≤—Å–µ –ø–∞—Ä—ã! üÉè');
    }
    
    window.memoryClick = async function(idx) {
        const cards = document.querySelectorAll('.memory-card');
        const card = cards[idx];
        
        if (card.classList.contains('flipped') || card.classList.contains('matched')) return;
        if (gameState.flipped.length >= 2) return;
        
        card.classList.add('flipped');
        gameState.flipped.push(idx);
        
        if (gameState.flipped.length === 2) {
            const [i1, i2] = gameState.flipped;
            const result = await action('memory_check', {
                card1: gameState.cards[i1],
                card2: gameState.cards[i2]
            });
            
            setComment(result.comment);
            
            setTimeout(() => {
                if (result.match) {
                    cards[i1].classList.add('matched');
                    cards[i2].classList.add('matched');
                    gameState.matched += 2;
                    
                    if (gameState.matched === gameState.cards.length) {
                        setComment('–í—Å–µ –ø–∞—Ä—ã –Ω–∞–π–¥–µ–Ω—ã! üéâ');
                        action('game_result', {result: 'lose'});
                        updateStats();
                    }
                } else {
                    cards[i1].classList.remove('flipped');
                    cards[i2].classList.remove('flipped');
                }
                gameState.flipped = [];
            }, 800);
        }
    };
    
    // Reaction
    function initReaction(container) {
        container.innerHTML = `
            <div class="reaction-area">
                <p>–ù–∞–∂–º–∏ –Ω–∞ –∫—Ä—É–≥, –∫–æ–≥–¥–∞ –æ–Ω —Å—Ç–∞–Ω–µ—Ç –∫—Ä–∞—Å–Ω—ã–º!</p>
                <div class="reaction-target waiting" id="reaction-target">‚è≥</div>
                <div class="reaction-result" id="reaction-result"></div>
                <button onclick="startReaction()">–ù–∞—á–∞—Ç—å</button>
            </div>
        `;
        setComment('–ü—Ä–æ–≤–µ—Ä–∏–º —Ç–≤–æ—é —Ä–µ–∞–∫—Ü–∏—é! ‚ö°');
    }
    
    window.startReaction = function() {
        const target = document.getElementById('reaction-target');
        target.className = 'reaction-target waiting';
        target.textContent = '‚è≥';
        target.onclick = null;
        document.getElementById('reaction-result').textContent = '';
        
        const delay = 2000 + Math.random() * 3000;
        gameState.reactionStart = null;
        
        setTimeout(() => {
            target.className = 'reaction-target ready';
            target.textContent = 'üéØ';
            gameState.reactionStart = Date.now();
            target.onclick = async () => {
                if (!gameState.reactionStart) return;
                const time = Date.now() - gameState.reactionStart;
                target.className = 'reaction-target clicked';
                target.textContent = '‚úì';
                
                const result = await action('reaction_result', {time_ms: time});
                document.getElementById('reaction-result').textContent = `${time} –º—Å - ${result.rating}`;
                setComment(result.comment);
            };
        }, delay);
    };
    
    // Snake
    function initSnake(container) {
        container.innerHTML = `
            <div class="snake-area">
                <canvas class="snake-canvas" id="snake-canvas" width="240" height="240"></canvas>
                <div class="snake-score">–°—á—ë—Ç: <span id="snake-score">0</span></div>
                <div class="snake-controls">
                    <button onclick="snakeDir(-1,0)">‚Üê</button>
                    <button onclick="snakeDir(0,-1)">‚Üë</button>
                    <button onclick="snakeDir(0,1)">‚Üì</button>
                    <button onclick="snakeDir(1,0)">‚Üí</button>
                </div>
            </div>
        `;
        
        const canvas = document.getElementById('snake-canvas');
        const ctx = canvas.getContext('2d');
        const size = 15;
        const grid = canvas.width / size;
        
        gameState.snake = [{x: 5, y: 5}];
        gameState.food = {x: 10, y: 10};
        gameState.dir = {x: 1, y: 0};
        gameState.score = 0;
        gameState.snakeInterval = null;
        
        function draw() {
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#ff69b4';
            ctx.fillRect(gameState.food.x * size, gameState.food.y * size, size-1, size-1);
            
            ctx.fillStyle = '#4ade80';
            gameState.snake.forEach((s, i) => {
                ctx.fillStyle = i === 0 ? '#22c55e' : '#4ade80';
                ctx.fillRect(s.x * size, s.y * size, size-1, size-1);
            });
        }
        
        function update() {
            const head = {
                x: gameState.snake[0].x + gameState.dir.x,
                y: gameState.snake[0].y + gameState.dir.y
            };
            
            if (head.x < 0 || head.x >= grid || head.y < 0 || head.y >= grid ||
                gameState.snake.some(s => s.x === head.x && s.y === head.y)) {
                clearInterval(gameState.snakeInterval);
                setComment('–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –°—á—ë—Ç: ' + gameState.score);
                return;
            }
            
            gameState.snake.unshift(head);
            
            if (head.x === gameState.food.x && head.y === gameState.food.y) {
                gameState.score++;
                document.getElementById('snake-score').textContent = gameState.score;
                gameState.food = {
                    x: Math.floor(Math.random() * grid),
                    y: Math.floor(Math.random() * grid)
                };
            } else {
                gameState.snake.pop();
            }
            
            draw();
        }
        
        draw();
        if (gameState.snakeInterval) clearInterval(gameState.snakeInterval);
        gameState.snakeInterval = setInterval(update, 150);
        setComment('–£–ø—Ä–∞–≤–ª—è–π —Å—Ç—Ä–µ–ª–∫–∞–º–∏! üêç');
    }
    
    window.snakeDir = function(x, y) {
        if ((x === -gameState.dir.x && y === 0) || (y === -gameState.dir.y && x === 0)) return;
        gameState.dir = {x, y};
    };
    
    document.addEventListener('keydown', (e) => {
        if (currentGame !== 'snake') return;
        const dirs = {ArrowLeft: [-1,0], ArrowRight: [1,0], ArrowUp: [0,-1], ArrowDown: [0,1]};
        if (dirs[e.key]) snakeDir(...dirs[e.key]);
    });
    
    async function updateStats() {
        const result = await action('get_stats');
        if (result.stats) {
            document.getElementById('wins').textContent = result.stats.wins || 0;
            document.getElementById('losses').textContent = result.stats.losses || 0;
        }
    }
    
    updateStats();
})();
</script>
